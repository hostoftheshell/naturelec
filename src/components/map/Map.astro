---
import { Icon } from "astro-icon/components";
import { Circle, Leaflet, Popup } from "astro-leaflet";

import { getLocaleFromUrl } from "@/js/localeUtils";
import { getTranslatedData } from "@/js/translationUtils";

const currLocale = getLocaleFromUrl(Astro.url);
const siteData = getTranslatedData("siteData", currLocale);

const siteName = siteData.name;
const firstPart = siteName.substring(0, 5); // "NATUR"
const secondPart = siteName.substring(5); // "ELEC"

const getInitialZoom = () => {
	if (typeof window !== "undefined") {
		return window.innerWidth < 768 ? 7 : 9;
	}
	return 8;
};

// Compact popup content with your naturelec icon
const compactPopupContent = `
<div style="padding: 12px;">
	<div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 12px; font-size: 18px; color: var(--foreground);">
		<div style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;">
		<svg xmlns="http://www.w3.org/2000/svg" width="13.668" height="23.981"><path fill="#4e7a32" d="M12.263 0h-.002c-.018.003-.029.028-.073.175a6.318 6.318 0 0 1-1.275 2.336 9.48 9.48 0 0 1-.701.712c-.588.525-1.283 1.003-2.193 1.508-.535.298-1.076.57-2.248 1.135-1.293.623-2.07 1.04-2.717 1.454-.869.558-1.547 1.167-2.022 1.818-.612.84-.946 1.775-1.024 2.91-.016.235-.006.915.016 1.11.125 1.105.59 2.12 1.404 3.049.279.318.618.65.938.895l.103.079-.119.142c-.27.325-.524.617-.64.76-.848 1.043-1.156 1.585-1.27 2.23-.055.31-.068.682-.031.896.093.545.474.987 1.117 1.298.441.213.997.369 1.642.46.315.045.777.086.97.086.054 0 .093.004.103.012a.195.195 0 0 1 .034.068c.07.22.276.429.56.571.248.125.629.223.991.257l.152.015c.067.006.634.006.696 0l.061-.007.006-.527.475-.005c.427-.005.479-.007.502-.023.046-.03.05-.117.007-.156-.02-.017-.052-.019-.503-.024l-.481-.005-.005-.692h.47c.517 0 .515 0 .54-.06.016-.039.007-.093-.02-.118-.02-.018-.05-.02-.504-.024l-.481-.005-.006-.53-.063-.005a5.052 5.052 0 0 0-1.154.056c-.632.116-1.081.385-1.223.734-.018.044-.029.059-.046.062-.041.006-.625-.019-.808-.034-.737-.063-1.391-.217-1.845-.434-.46-.22-.777-.539-.887-.89-.05-.157-.06-.276-.055-.556.007-.281.02-.389.074-.611.094-.38.25-.71.553-1.163.261-.39.606-.755 1.103-1.43l.2-.274.07.045c.815.533 1.847.896 2.923 1.001 1.134.11 2.33-.06 3.262-.469 2.898-1.27 4.533-4.241 4.795-8.657.136-2.303-.134-5.053-.73-7.433-.247-.99-.526-1.746-.64-1.742zm-.135 2.678a.947.947 0 0 1 0 .105 8.432 8.432 0 0 1-.248 1.683 12.69 12.69 0 0 1-.437 1.349.546.546 0 0 0-.024.076c-.008.047.347-.562.816-1.294.01 0 .126.614.136.626.101-.083.722-.927.63-.767l-.641 1.118-.145-.56-.67.808c-.154.186-.206.263-.23.317l-.095.222a23.2 23.2 0 0 1-.386.827c-.08.15-.16.3-.236.456l-.074.137c-.117.216-.24.427-.364.64l-.331.542c-.253.405-.392.607-.37.587l1.546-1.445-.047 1.095 2.216-1.494c.082-.055-2.473 2.19-2.473 2.184l.1-1.169-1.205.797c-.2.132-.237.161-.27.209l-.14.202c-.055.081-.134.194-.176.251l-.494.674a7.05 7.05 0 0 0-.113.146c-.102.136-.144.19-.152.197a10.957 10.957 0 0 1-.205.262 1.213 1.213 0 0 0-.074.099l2.392-.36-.733-.271 2.527-.265-1.784.295.485.298c.033.021.034.025.01.027l-2.921.297c-.005 0-.056.068-.116.144-.114.142-.248.304-.258.313a14.302 14.302 0 0 1-.301.359l-.228.262c-.16.185-.339.386-.527.592-.179.196-.165.186-.232.255-.088.092-.308.328-.359.384-.443.451-.127.135-.56.574a50.09 50.09 0 0 1-1.234 1.197l-.182.168a19.353 19.353 0 0 1-.393.356 15.882 15.882 0 0 1-.37.328c0-.004.05-.055.131-.134.553-.54.902-.893.9-.916l-.208-2.353-1.274.857-.253-3.472.566 2.782 1.369-.952-.178 3.124c0 .013.457-.454 1.044-1.082a55.697 55.697 0 0 0 .532-.581 46.739 46.739 0 0 0 1.97-2.328l.096-.12-.01-2.26-.94.774.445-4.021.01 3.347.891-.664-.377 2.793c-.001.007.18-.219.349-.444.095-.126.19-.25.284-.378.038-.051.123-.167.188-.258l.125-.17c.071-.093.131-.194.201-.288.062-.09.135-.193.16-.231.357-.517.666-1.004.831-1.28l.094-.156.422-2.105-.798.268c.025-.098.89-2.669.89-2.663l-.474 2.316.793-.315-.81 2.453c-.002.004.058-.087.094-.152l.123-.217c.129-.225.19-.345.213-.384.056-.096.345-.669.435-.86.516-1.105.827-2.033 1-2.981.025-.144.065-.425.08-.566.015-.144.023-.212.026-.216z"/><path fill="#f3e852" d="M12.13 2.678h-.001c-.003.004-.01.071-.026.215-.014.141-.054.422-.08.566-.172.949-.483 1.876-1 2.982-.09.19-.38.763-.435.859-.023.04-.084.16-.212.384-.054.095-.11.192-.123.217a2.067 2.067 0 0 1-.095.152l.81-2.453-.792.316.473-2.316c0-.006-.865 2.564-.89 2.663l.799-.269-.423 2.105-.094.156a25.756 25.756 0 0 1-.99 1.511c-.07.094-.13.195-.202.288a5.95 5.95 0 0 0-.125.17c-.065.091-.15.207-.188.258-.093.128-.188.253-.284.378-.168.225-.35.45-.35.444l.378-2.793-.89.664-.011-3.347-.446 4.022.942-.774.01 2.26-.096.12-.47.584a30.698 30.698 0 0 1-.688.818 115.27 115.27 0 0 1-.323.375 46.8 46.8 0 0 1-1.021 1.131c-.588.628-1.045 1.096-1.045 1.082l.178-3.124-1.369.953-.566-2.783.253 3.473 1.275-.857.207 2.352c.002.024-.347.377-.9.916a2.3 2.3 0 0 0-.131.134 50.09 50.09 0 0 0 2.179-2.05c.433-.438.117-.122.56-.573.05-.056.272-.292.36-.383l.232-.255a29.877 29.877 0 0 0 .754-.855 14.302 14.302 0 0 0 .301-.359c.01-.009.144-.17.258-.313.06-.075.111-.143.116-.144l2.921-.297c.024-.002.024-.005-.01-.026l-.484-.298 1.784-.296-2.527.265.733.27-2.392.36c-.002.001.031-.045.073-.097a10.996 10.996 0 0 0 .205-.263c.008-.006.05-.06.153-.197.046-.06.096-.127.112-.146.016-.019.344-.467.494-.673a14.164 14.164 0 0 0 .316-.454c.034-.047.07-.076.27-.209l1.206-.797-.1 1.17c0 .006 2.554-2.24 2.472-2.184L10.959 9.2l.048-1.096L9.46 9.55c-.022.02.118-.182.37-.586.11-.181.221-.361.33-.544.125-.211.249-.423.365-.639l.075-.136c.076-.156.155-.306.236-.457a23.194 23.194 0 0 0 .481-1.049c.024-.054.075-.131.23-.317l.67-.807.144.56.641-1.12c.092-.158-.528.685-.63.768-.01-.011-.125-.626-.136-.626-.468.732-.824 1.341-.816 1.294a.549.549 0 0 1 .025-.076c.158-.402.341-.968.437-1.349a8.432 8.432 0 0 0 .246-1.683.94.94 0 0 0 .001-.104zM4.078 15.857s1.562.072 0 0z"/><path fill="#f3e852" d="m8.088 13.288.98 1.083-3.773.375 4.67.142L8.84 13.75l2.682-.267zM6.249 11.162l-.57.59-.135-2.353L5.4 12.3l.6-.678.097 1.672z"/></svg>
		</div>
		<div style="font-family: 'Barlow Condensed', sans-serif; font-weight: 500; font-size: 18px;">
			<span style="color: var(--accent);">${firstPart}</span><span style="color: var(--accent-sec);">${secondPart}</span>
		</div>
	</div>
	<p style="margin: 0; color: var(--muted-foreground, #666); text-align: center; font-size: 14px;">
	Nous intervenons dans cette zone
	</p>
</div>`;
---

<div class="h-full">
	<!-- Mobile map -->
	<div class="block h-full md:hidden">
		<Leaflet options={{ center: [47.629289, 3.741859], zoom: 8 }} style="height: 100%;">
			<Circle
				latlng={[47.629289, 3.741859]}
				options={{
					color: "var(--primary)",
					fillColor: "var(--primary)",
					fillOpacity: 0.3,
					radius: 50000,
				}}
			>
				<Popup
					latlng={[47.629289, 3.741859]}
					content={compactPopupContent}
					options={{
						className: "naturelec-popup",
						maxWidth: 250,
						autoPan: true,
						offset: [0, -10],
					}}
				/>
			</Circle>
		</Leaflet>
	</div>

	<!-- Desktop map -->
	<div class="hidden h-full md:block">
		<Leaflet options={{ center: [47.629289, 3.741859], zoom: 9 }} style="height: 100%;">
			<Circle
				latlng={[47.629289, 3.741859]}
				options={{
					color: "var(--primary)",
					fillColor: "var(--primary)",
					fillOpacity: 0.3,
					radius: 50000,
				}}
			>
				<Popup
					latlng={[47.629289, 3.741859]}
					content={compactPopupContent}
					options={{
						className: "naturelec-popup",
						maxWidth: 300,
						autoPan: true,
						offset: [0, -10],
					}}
				/>
			</Circle>
		</Leaflet>
	</div>
</div>
